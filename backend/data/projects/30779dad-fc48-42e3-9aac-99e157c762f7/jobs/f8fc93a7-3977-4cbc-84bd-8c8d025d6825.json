{
  "id": "f8fc93a7-3977-4cbc-84bd-8c8d025d6825",
  "jobName": "Ligação",
  "selectSql": "WITH base AS (\r\n  SELECT\r\n    l.*,\r\n    NULLIF(l.idmedidor, 0) AS idmedidor_norm,\r\n    l.ctid\r\n  FROM ligacao l\r\n),\r\nranked AS (\r\n  SELECT\r\n    b.*,\r\n    row_number() OVER (\r\n      PARTITION BY b.idmedidor_norm\r\n      ORDER BY b.id DESC   -- mais novo\r\n    ) AS rn\r\n  FROM base b\r\n)\r\nSELECT\r\n  l.id,\r\n  (CASE\r\n    WHEN l.dtligacao ~ '^[0-9]{8}$'\r\n     AND to_char(to_date(l.dtligacao, 'YYYYMMDD'), 'YYYYMMDD') = l.dtligacao\r\n    THEN to_date(l.dtligacao, 'YYYYMMDD')\r\n    ELSE NULL\r\n  END)::text AS dtligacao,\r\n  (CASE\r\n    WHEN l.datainstalacaoagua ~ '^[0-9]{8}$'\r\n     AND to_char(to_date(l.datainstalacaoagua, 'YYYYMMDD'), 'YYYYMMDD') = l.datainstalacaoagua\r\n    THEN to_date(l.datainstalacaoagua, 'YYYYMMDD')\r\n    ELSE NULL\r\n  END)::text AS datainstalacaoagua,\r\n  (CASE\r\n    WHEN l.datainstalacaoesgoto ~ '^[0-9]{8}$'\r\n     AND to_char(to_date(l.datainstalacaoesgoto, 'YYYYMMDD'), 'YYYYMMDD') = l.datainstalacaoesgoto\r\n    THEN to_date(l.datainstalacaoesgoto, 'YYYYMMDD')\r\n    ELSE NULL\r\n  END)::text AS datainstalacaoesgoto,\r\n  left(l.inscricao,255) inscricao,\r\n  (CASE WHEN l.lote = '' THEN NULL ELSE l.lote END)::int AS lote,\r\n  l.numeromoradores,\r\n  l.quadra,\r\n  l.quadraent,\r\n  l.quadraleit,\r\n  l.seqent,\r\n  l.seqleit,\r\n  l.idbacia,\r\n  l.idsituacaocavalete,\r\n  ci.id id_cliente_inquilino,\r\n  c.id id_cliente_proprietario,\r\n  l.idcobrancafase id_cobranca_fase,\r\n  l.idtipocobranca id_cobranca_tipo,\r\n  l.id id_endereco_imovel,\r\n  l.idtipoentrega id_entrega_tipo,\r\n  CASE WHEN l.idtipofaturamento \u003e 3 THEN 1 ELSE l.idtipofaturamento END id_faturamento_tipo,\r\n  l.idfonteabastecimento id_fonte_abastecimento,\r\n  l.idgrupoent id_grupo_entrega,\r\n  l.idgrupoleit id_grupo_medicao,\r\n  l.idsituacaoimovel id_imovel_situacao,\r\n  l.idsituacaoligacao id_ligacao_situacao,\r\n  CASE WHEN l.idtipoligacao \u003e 4 THEN 3 ELSE l.idtipoligacao END id_ligacao_tipo,\r\n  l.idpadraoinstalacao id_local_padrao_instalacao,\r\n  CASE\r\n    WHEN l.idmedidor_norm IS NULL THEN NULL\r\n    WHEN l.rn = 1 THEN l.idmedidor_norm\r\n    ELSE NULL\r\n  END AS id_medidor,\r\n  l.idtipopavimento id_pavimento_tipo,\r\n  l.idreservatorio id_reservatorio,\r\n  l.idzonamacro id_zona_macro,\r\n  l.idzonapressao id_zona_pressao,\r\n  false cosolidada,\r\n  l.iddistrito id_distrito,\r\n  l.areaconstruida area_construida,\r\n  l.areaverde area_verde,\r\n  l.capacidadereservatorio capacidade_reservatorio,\r\n  l.iddiametroramalagua diametro_ramal_agua,\r\n  l.iddiametroramalesgoto diametro_ramal_esgoto,\r\n  l.distanciaramalagua distancia_ramal_agua,\r\n  l.distanciaramalesgoto distancia_ramal_esgoto,\r\n  left(l.observacaoligacao,255) observacao,\r\n  false possui_piscina,\r\n  0 volume_piscina,\r\n  l.idtipocalcada id_calcada_tipo,\r\n  l.id id_endereco_entrega,\r\n  1 id_imovel_tipo,\r\n  1 id_ocupacao_tipo,\r\n  l.idtiporede id_rede_agua_tipo,\r\n  l.idposicaorede id_rede_posicao_agua,\r\n  l.idposicaoredeesgoto id_rede_posicao_esgoto,\r\n  (l.idfontealternativa + 100) id_fonte_alternativa,\r\n  l.subunidleit sub_unidade_entrega,\r\n  l.subunidleit sub_unidade_leitura,\r\n  0 area_coberta\r\nFROM ranked l\r\nLEFT JOIN cliente c  ON c.id  = l.idcliente\r\nLEFT JOIN cliente ci ON ci.id = l.idclienteinquilino",
  "insertSql": "INSERT INTO ${SCHEMA}.ligacao_imovel (id, data_cadastro_ligacao, data_instalacao_agua, data_instalacao_esgoto, inscricao_imovel, numero_lote, numero_moradores, quadra, quadra_entrega, quadra_leitura,  sequencia_entrega, sequencia_leitura, id_bacia, id_cavalete_situacao, id_cliente_inquilino, id_cliente_proprietario, id_cobranca_fase, id_cobranca_tipo, id_endereco_imovel, id_entrega_tipo, id_faturamento_tipo, id_fonte_abastecimento, id_grupo_entrega, id_grupo_medicao, id_imovel_situacao, id_ligacao_situacao, id_ligacao_tipo, id_local_padrao_instalacao, id_medidor, id_pavimento_tipo, id_reservatorio, id_zona_macro, id_zona_pressao, consolidada, id_distrito, area_construida, area_verde, capacidade_reservatorio, diametro_ramal_agua, diametro_ramal_esgoto, distancia_ramal_agua, distancia_ramal_esgoto, observacao, possui_piscina, volume_piscina, id_calcada_tipo, id_endereco_entrega, id_imovel_tipo, id_ocupacao_tipo, id_rede_agua_tipo, id_rede_posicao_agua, id_rede_posicao_esgoto, id_fonte_alternativa, sub_unidade_entrega, sub_unidade_leitura, area_coberta)",
  "columns": [
    "id",
    "dtligacao",
    "datainstalacaoagua",
    "datainstalacaoesgoto",
    "inscricao",
    "lote",
    "numeromoradores",
    "quadra",
    "quadraent",
    "quadraleit",
    "seqent",
    "seqleit",
    "idbacia",
    "idsituacaocavalete",
    "id_cliente_inquilino",
    "id_cliente_proprietario",
    "id_cobranca_fase",
    "id_cobranca_tipo",
    "id_endereco_imovel",
    "id_entrega_tipo",
    "id_faturamento_tipo",
    "id_fonte_abastecimento",
    "id_grupo_entrega",
    "id_grupo_medicao",
    "id_imovel_situacao",
    "id_ligacao_situacao",
    "id_ligacao_tipo",
    "id_local_padrao_instalacao",
    "id_medidor",
    "id_pavimento_tipo",
    "id_reservatorio",
    "id_zona_macro",
    "id_zona_pressao",
    "cosolidada",
    "id_distrito",
    "area_construida",
    "area_verde",
    "capacidade_reservatorio",
    "diametro_ramal_agua",
    "diametro_ramal_esgoto",
    "distancia_ramal_agua",
    "distancia_ramal_esgoto",
    "observacao",
    "possui_piscina",
    "volume_piscina",
    "id_calcada_tipo",
    "id_endereco_entrega",
    "id_imovel_tipo",
    "id_ocupacao_tipo",
    "id_rede_agua_tipo",
    "id_rede_posicao_agua",
    "id_rede_posicao_esgoto",
    "id_fonte_alternativa",
    "sub_unidade_entrega",
    "sub_unidade_leitura",
    "area_coberta"
  ],
  "primaryKeys": null,
  "recordsPerPage": 1000,
  "type": "insert",
  "stopOnError": true,
  "left": 500,
  "top": 3180
}