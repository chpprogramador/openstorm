<div class="errors-page-container">
  <mat-card class="page-header">
    <mat-card-header>
      <mat-card-title>
        <mat-icon color="warn">history</mat-icon>
        Historico & Erros
      </mat-card-title>
      <mat-card-subtitle>
        Timeline de execucoes com estatisticas e detalhes de erro
      </mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <mat-card class="pipeline-selector">
    <mat-card-content>
      <div class="selector-row">
        <mat-form-field appearance="outline" class="pipeline-select">
          <mat-label>Selecione um Pipeline</mat-label>
          <mat-select [(value)]="selectedPipelineId" (selectionChange)="onPipelineChange($event.value)">
            <mat-option *ngFor="let pipeline of formattedPipelines" [value]="pipeline.id">
              {{ pipeline.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="selector-actions">
          <button mat-stroked-button (click)="downloadPipelineReport()" [disabled]="!selectedPipelineId || isLoading">
            <mat-icon>download</mat-icon>
            Baixar PDF
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner></mat-spinner>
    <p>Carregando dados do pipeline...</p>
  </div>

  <mat-card class="pipeline-stats" *ngIf="pipelineStats && !isLoading">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>analytics</mat-icon>
        Estatisticas do Pipeline
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="stats-summary">
        <div class="summary-item">
          <span class="summary-label">Pipeline</span>
          <span class="summary-value">{{ pipelineStats.project || pipelineStats.pipeline_id }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Inicio</span>
          <span class="summary-value">{{ formatDateTime(pipelineStats.started_at) }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Fim</span>
          <span class="summary-value">{{ formatDateTime(pipelineStats.ended_at) }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Duracao</span>
          <span class="summary-value">{{ formatDuration(pipelineStats.duration, pipelineStats.started_at, pipelineStats.ended_at) }}</span>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">{{ pipelineStats.total_jobs }}</div>
          <div class="stat-label">Total de Jobs</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ pipelineStats.total_processed }}</div>
          <div class="stat-label">Registros Processados</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ formatDuration(pipelineStats.duration, pipelineStats.started_at, pipelineStats.ended_at) }}</div>
          <div class="stat-label">Duracao</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" [class]="getStatusClass(pipelineStats.status)">
            {{ getStatusLabel(pipelineStats.status) }}
          </div>
          <div class="stat-label">Status</div>
        </div>
      </div>

      <div class="job-stats" *ngIf="pipelineStats.job_stats">
        <h4>Status dos Jobs:</h4>
        <div class="job-stats-chips">
          <span class="job-stat-chip done" *ngIf="pipelineStats.job_stats['done']">
            <mat-icon>check_circle</mat-icon>
            Concluidos: {{ pipelineStats.job_stats['done'] }}
          </span>
          <span class="job-stat-chip error" *ngIf="pipelineStats.job_stats['error']">
            <mat-icon>error</mat-icon>
            Com Erro: {{ pipelineStats.job_stats['error'] }}
          </span>
          <span class="job-stat-chip running" *ngIf="pipelineStats.job_stats['running']">
            <mat-icon>play_circle</mat-icon>
            Executando: {{ pipelineStats.job_stats['running'] }}
          </span>
          <span class="job-stat-chip pending" *ngIf="pipelineStats.job_stats['pending']">
            <mat-icon>schedule</mat-icon>
            Pendentes: {{ pipelineStats.job_stats['pending'] }}
          </span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="timeline-card" *ngIf="pipelineLog && !isLoading">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>timeline</mat-icon>
        Timeline de Execucoes
      </mat-card-title>
      <mat-card-subtitle>
        {{ pipelineLog.jobs.length || 0 }} jobs nesta execucao
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="timeline">
        <div class="timeline-item" *ngFor="let job of pipelineLog.jobs; let i = index">
          <div class="timeline-rail">
            <div class="timeline-node" [ngClass]="getStatusClass(job.status)"></div>
            <div class="timeline-line" *ngIf="i < (pipelineLog.jobs.length - 1)"></div>
          </div>
          <div class="timeline-content">
            <div class="timeline-header">
              <div class="job-title">
                <mat-icon [ngClass]="getStatusClass(job.status)">
                  {{ getStatusIcon(job.status) }}
                </mat-icon>
                <span>{{ job.job_name }}</span>
              </div>
              <div class="job-meta">
                <span class="meta-chip" [ngClass]="getStatusClass(job.status)">
                  {{ getStatusLabel(job.status) }}
                </span>
                <span class="meta-chip neutral">
                  {{ job.processed }} / {{ job.total }}
                </span>
                <span class="meta-chip neutral">
                  {{ getDuration(job.started_at, job.ended_at) }}
                </span>
              </div>
            </div>

            <div class="timeline-body">
              <div class="time-range">
                <span>Inicio: {{ formatDateTime(job.started_at) }}</span>
                <span>Fim: {{ formatDateTime(job.ended_at) }}</span>
              </div>

              <div class="error-block" *ngIf="job.status === 'error'">
                <div class="error-title">
                  <mat-icon color="warn">error_outline</mat-icon>
                  <span>Erro</span>
                </div>
                <div class="error-message">{{ job.error }}</div>
                <div class="error-details" *ngIf="job.error_details || job.error_type || job.error_code">
                  <div *ngIf="job.error_type"><strong>Tipo:</strong> {{ job.error_type }}</div>
                  <div *ngIf="job.error_code"><strong>Codigo:</strong> {{ job.error_code }}</div>
                  <div *ngIf="job.error_details?.['suggestion']"><strong>Sugestao:</strong> {{ job.error_details?.['suggestion'] }}</div>
                  <div *ngIf="job.error_details?.['original_error']"><strong>Detalhe:</strong> {{ job.error_details?.['original_error'] }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <app-error-viewer
    *ngIf="errorSummary && !isLoading && errorSummary.total_errors > 0"
    [pipelineId]="selectedPipelineId"
    [errorSummary]="errorSummary">
  </app-error-viewer>

  <mat-card class="no-selection" *ngIf="!selectedPipelineId && !isLoading">
    <mat-card-content>
      <div class="no-selection-content">
        <mat-icon color="primary">info</mat-icon>
        <h3>Selecione um Pipeline</h3>
        <p>Escolha um pipeline na lista acima para visualizar seus erros e estatisticas.</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
